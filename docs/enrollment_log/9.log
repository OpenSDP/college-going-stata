
<span class="stcmt">// College Enrollment Rates by 8th Grade Achievement Quartile Bubbles</span>

<span class="stcmt">// Step 1: Load the college-going analysis file into Stata</span>
use "$data/college_going_analysis", clear

<span class="stcmt">// Step 2: Keep students in high school graduation cohorts you can observe enrolling in college the fall after graduation AND have non-missing eighth grade test scores</span>
local chrt_grad_begin = ${chrt_grad_begin}
local chrt_grad_end = ${chrt_grad_end}
keep if (chrt_grad &gt;= `chrt_grad_begin' &amp; chrt_grad &lt;= `chrt_grad_end')
keep if qrt_8_math != .

<span class="stcmt">// Step 3: Create agency- and school-level average outcomes for each quartile</span>
<span class="stcmt">// 1. Calculate the mean of each outcome variable by high school</span>
collapse (sum) enrl_1oct_grad_yr1_any hs_diploma, by(last_hs_name qrt_8_math)
gen pct_enrl = enrl_1oct_grad_yr1_any / hs_diploma * 100
<span class="stcmt">// 2. Calculate the mean of each outcome variable for the agency as a whole</span>
egen num = sum(enrl_1oct_grad_yr1_any), by(qrt_8_math)
egen denom = sum(hs_diploma), by(qrt_8_math)
gen agency_avg = num / denom * 100
drop num denom

<span class="stcmt">// Step 4: Create a variable to identify the test score quartile</span>
gen agency_quartile_code = .
forvalues qrt = 1(1)4 {
	local qrt_plot = `qrt' * 2
	replace agency_quartile_code = 1.`qrt_plot' if qrt_8_math == `qrt'
}

<span class="stcmt">// Step 5: Prepare to graph the results</span>
<span class="stcmt">// Generate a cohort label to be used in the footnote for the graph</span>
local temp_begin = `chrt_grad_begin'-1
local temp_end = `chrt_grad_end'-1
if `chrt_grad_begin'==`chrt_grad_end' {
    local chrt_label "`temp_begin'-`chrt_grad_begin'"
}
else {
    local chrt_label "`temp_begin'-`chrt_grad_begin' through `temp_end'-`chrt_grad_end'"
}

<span class="stcmt">// Step 6: Graph the results</span>
#delimit ;
graph twoway scatter pct_enrl agency_quartile_code [aweight = hs_diploma],
    msymbol(Oh) msize(vsmall) mcolor(dknavy) ||
scatter agency_avg agency_quartile_code,
    mcolor(cranberry) msymbol(D) msize(small)
title("College Enrollment Rates Among High School"
"Graduates Within Quartile Of Prior Achievement,"
"By High School", size(med))
    xscale(range(1 2)) yscale(range(0 105)) ylabel(0 20 40 60 80 100)
    xlabel(1.2 "Q1" 1.4 "Q2" 1.6 "Q3" 1.8 "Q4", labsize(small))
    xtitle(" " "Quartile of Prior Achievement") ytitle("Percent" " ")
    ylabel(,nogrid) legend(off)
graphregion(color(white) fcolor(white) lcolor(white))
plotregion(color(white) fcolor(white) lcolor(white))
note("Sample: `chrt_label' high school graduates. Postsecondary enrollment outcomes from NSC matched records."
"All other data from ${agency_name} administrative records.", size(vsmall));
#delimit cr

graph export "figures/D7_Col_Enrl_by_Eighth_Qrt_Bubbles.png", replace width(1600) height(1200)

